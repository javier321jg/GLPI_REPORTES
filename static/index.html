<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Reportes GLPI – SENASA</title>

<link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://code.highcharts.com/highcharts.js"></script>
<script src="https://code.highcharts.com/modules/variable-pie.js"></script>
<script src="https://code.highcharts.com/modules/exporting.js"></script>
<script src="https://code.highcharts.com/modules/export-data.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.19.3/xlsx.full.min.js"></script>

<style>
  :root { 
    --azul:#0d2d62; 
    --azul2:#113b7f; 
    --turquesa:#00d4ff;
    --accent:#ff6b35;
    --stroke: rgba(255,255,255,.08); 
  }
  
  * { box-sizing: border-box; }
  
  body{ 
    background: linear-gradient(135deg, #0a0f1a 0%, #0f1b2e 100%); 
    color:#e9eef5; 
    font-family: Inter, system-ui, sans-serif;
    min-height: 100vh;
  }
  
  header{ 
    background: linear-gradient(135deg, var(--azul) 0%, var(--azul2) 50%, #1a4d7f 100%);
    box-shadow: 0 8px 32px rgba(0,0,0,0.3);
    backdrop-filter: blur(10px);
    border-bottom: 2px solid rgba(0,212,255,.3);
  }
  
  .senasa-logo {
    background: rgba(255,255,255,0.95);
    padding: 0.3rem 0.5rem;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .panel{ 
    background: rgba(15,22,37,0.8);
    border:1px solid var(--stroke); 
    border-radius:16px;
    backdrop-filter: blur(10px);
    transition: all 0.3s ease;
  }
  
  .panel:hover {
    border-color: rgba(0,212,255,.3);
    box-shadow: 0 8px 24px rgba(0,212,255,.1);
  }
  
  .btn{ 
    padding:.6rem .9rem; 
    border-radius:10px; 
    background: linear-gradient(135deg, #00d4ff, #0099cc);
    color:#000; 
    font-weight: 600;
    border: none;
    cursor: pointer;
    transition: all 0.3s ease;
  }
  
  .btn:hover{ 
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(0,212,255,.4);
    filter: brightness(1.1);
  }
  
  .upload-zone{ 
    border:2px dashed var(--turquesa); 
    padding:2rem; 
    border-radius:14px; 
    cursor:pointer;
    background: rgba(0,212,255,.05);
    transition: all 0.3s ease;
  }
  
  .upload-zone:hover{ 
    background:rgba(0,212,255,.15);
    border-color: var(--accent);
    transform: scale(1.01);
  }
  
  .chart-container{ width:100%; height:360px; }
  
  .kpi-card {
    background: linear-gradient(135deg, rgba(0,212,255,.1), rgba(0,212,255,.05));
    border: 1px solid rgba(0,212,255,.2);
    border-radius: 14px;
    padding: 1.5rem;
    transition: all 0.3s ease;
  }
  
  .kpi-card:hover {
    transform: translateY(-4px);
    border-color: rgba(0,212,255,.3);
    box-shadow: 0 8px 24px rgba(0,212,255,.15);
  }
  
  .kpi-label {
    text-transform: uppercase;
    font-size: 0.75rem;
    font-weight: 700;
    opacity: 0.8;
    letter-spacing: 0.05em;
  }
  
  .kpi-value {
    font-size: 2.5rem;
    font-weight: 800;
    background: linear-gradient(135deg, var(--turquesa), #00a8cc);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-top: 0.5rem;
  }
  
  table{ width:100%; border-collapse: collapse; }
  thead th{ 
    background: linear-gradient(135deg, var(--azul), #1a4d7f);
    color:#fff; 
    position: sticky; 
    top:0; 
    z-index:1;
    font-weight: 700;
  }
  th, td{ padding:.7rem .8rem; border-bottom: 1px solid #e5e7eb; color:#0a0f1a; }
  tbody tr:nth-child(odd){ background:#ffffff; }
  tbody tr:nth-child(even){ background:#f8fafc; }
  tbody tr:hover { background: #e6f2ff; }
  tfoot td{ background: linear-gradient(135deg, #eaf2ff, #d4e6ff); color:#0a0f1a; font-weight:700; }
  .table-wrap{ background:#ffffff; border-radius:12px; overflow:auto; box-shadow: 0 4px 20px rgba(0,0,0,.1); }
  
  .cell-colored {
    background: #d4e6ff !important;
    color: #0a0f1a;
    font-weight: 600;
  }
  
  .cell-zero {
    background: #ffffff !important;
    color: #999;
  }

  .spinner {
    background: linear-gradient(135deg, var(--turquesa), var(--accent));
  }
</style>
</head>
<body class="pb-12">
  <header class="p-5">
    <div class="max-w-7xl mx-auto flex items-center gap-4">
      <div class="senasa-logo">
        <img src="https://www.gob.pe/rails/active_storage/representations/redirect/eyJfcmFpbHMiOnsiZGF0YSI6MTQ1MDAsInB1ciI6ImJsb2JfaWQifX0=--d56e8d89845af7a460ccbe0d65ed319826301586/eyJfcmFpbHMiOnsiZGF0YSI6eyJmb3JtYXQiOiJwbmciLCJyZXNpemVfdG9fbGltaXQiOltudWxsLDQ4XX0sInB1ciI6InZhcmlhdGlvbiJ9fQ==--830247c4bafe7cadca50817d8559bf1a09e3aa28/Sin%20ti%CC%81tulo-1-01%20(1).png"
             alt="SENASA" class="h-8 w-auto"/>
      </div>
      <div class="flex-1">
        <h1 class="text-3xl font-extrabold tracking-wide bg-gradient-to-r from-cyan-300 to-blue-300 bg-clip-text text-transparent">Reportes GLPI – SENASA</h1>
        <p class="opacity-80 text-sm">Sistema inteligente de análisis de tickets</p>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto p-6 space-y-8">
    <section class="panel p-6">
      <form id="uploadForm" class="max-w-2xl mx-auto">
        <div class="upload-zone text-center" onclick="document.getElementById('file').click()">
          <i class="fas fa-cloud-upload-alt text-6xl mb-4 text-cyan-300"></i>
          <input id="file" type="file" name="file" accept=".csv" class="hidden" />
          <p class="text-lg font-semibold text-white/90">Arrastra tu CSV o haz clic para seleccionar</p>
          <p class="text-sm text-white/70 mt-2">Encabezados: ID, Fecha, Estado, Prioridad, Técnico, Categoría</p>
        </div>
      </form>
    </section>

    <section id="kpis" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-5 hidden">
      <div class="kpi-card">
        <div class="kpi-label">Total Tickets</div>
        <div id="k_total" class="kpi-value">0</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">Total Técnicos</div>
        <div id="k_tecnicos" class="kpi-value">0</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">Pendientes</div>
        <div id="k_pend" class="kpi-value">0</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">Eficiencia</div>
        <div id="k_eff" class="kpi-value">0%</div>
      </div>
    </section>

    <section id="charts" class="grid grid-cols-1 lg:grid-cols-2 gap-6 hidden">
      <div class="panel p-6">
        <div class="flex justify-between items-center mb-3">
          <h3 class="text-xl font-bold">Distribución por Categoría</h3>
          <button class="btn" onclick="exportChart('categChart')"><i class="fas fa-download mr-2"></i>JPG</button>
        </div>
        <div id="categChart" class="chart-container"></div>
      </div>
      <div class="panel p-6">
        <div class="flex justify-between items-center mb-3">
          <h3 class="text-xl font-bold">Estados</h3>
          <button class="btn" onclick="exportChart('estadoChart')"><i class="fas fa-download mr-2"></i>JPG</button>
        </div>
        <div id="estadoChart" class="chart-container"></div>
      </div>
      <div class="panel p-6 lg:col-span-2">
        <div class="flex justify-between items-center mb-3">
          <h3 class="text-xl font-bold">Tendencia Mensual</h3>
          <button class="btn" onclick="exportChart('trendChart')"><i class="fas fa-download mr-2"></i>JPG</button>
        </div>
        <div id="trendChart" class="chart-container"></div>
      </div>
    </section>

    <section id="tableSection" class="space-y-3 hidden">
      <div class="flex justify-between items-center">
        <h3 class="text-xl font-bold">Tickets por Técnico</h3>
        <div class="flex gap-2">
          <button class="btn" onclick="exportTableToExcel()"><i class="fas fa-file-excel mr-2"></i>Excel</button>
          <button class="btn" onclick="exportTableToPDF()"><i class="fas fa-file-pdf mr-2"></i>PDF</button>
          <button class="btn" onclick="exportTableToJPG()"><i class="fas fa-image mr-2"></i>JPG</button>
        </div>
      </div>
      <div class="table-wrap">
        <table id="techTable">
          <thead>
            <tr><th class="text-left text-white">Técnico</th><th class="text-right text-white">Total</th></tr>
          </thead>
          <tbody></tbody>
          <tfoot><tr><td>Total General</td><td class="text-right">0</td></tr></tfoot>
        </table>
      </div>
    </section>
  </main>

  <div id="overlay" class="fixed inset-0 bg-black/70 hidden items-center justify-center z-50">
    <div class="text-center text-white">
      <div class="relative w-20 h-20 mx-auto mb-4">
        <div class="spinner absolute inset-0 rounded-full opacity-75" style="animation: spin 3s linear infinite;"></div>
      </div>
      <p class="text-xl font-semibold">Procesando datos…</p>
    </div>
  </div>

<script>
  let dataStore = null, charts = {};
  const $ = (s)=>document.querySelector(s);
  const show = (id)=>$(id).classList.remove('hidden');
  const hide = (id)=>$(id).classList.add('hidden');

  Highcharts.setOptions({
    chart:{ backgroundColor:'transparent', style:{ fontFamily:'Inter, system-ui, sans-serif' } },
    title:{ text:null }, credits:{ enabled:false },
    legend:{ itemStyle:{ color:'#e9eef5' } },
    xAxis:{ labels:{ style:{ color:'#cfd8e3'} } },
    yAxis:{ title:{ text:null }, labels:{ style:{ color:'#cfd8e3'} } },
    colors:['#00d4ff','#00f5ff','#00e6e6','#00d4a8','#00c2ff','#a8d4ff']
  });

  document.getElementById('file').addEventListener('change', async (e)=>{
    if(!e.target.files.length) return;
    const form = new FormData(); form.append('file', e.target.files[0]);
    show('#overlay');
    try{
      const res = await fetch('/api/upload', { method:'POST', body:form });
      const json = await res.json();
      if(!json.success) throw new Error(json.error || 'Error procesando CSV');
      dataStore = json.data;
      renderAll();
    }catch(err){
      alert('Error: '+err.message);
    }finally{ hide('#overlay'); }
  });

  function renderAll(){
    show('#kpis'); show('#charts'); show('#tableSection');
    const s = dataStore.dashboard_stats;
    const total = Object.values(s.tickets_por_categoria||{}).reduce((a,b)=>a+b,0);
    const pendientes = s.tickets_por_estado?.Pendiente || s.tickets_por_estado?.pendiente || 0;
    const resueltos  = s.tickets_por_estado?.Resuelto || s.tickets_por_estado?.resuelto || 0;
    const totalEst = Object.values(s.tickets_por_estado||{}).reduce((a,b)=>a+b,0);
    const eff = totalEst ? (resueltos/totalEst)*100 : 0;

    $('#k_total').textContent = total.toLocaleString();
    $('#k_tecnicos').textContent = dataStore.technician_stats.length.toLocaleString();
    $('#k_pend').textContent = pendientes.toLocaleString();
    $('#k_eff').textContent = eff.toFixed(1)+'%';

    charts.categ = Highcharts.chart('categChart', {
      chart:{ type:'variablepie' },
      series:[{ innerSize:'55%', data: Object.entries(s.tickets_por_categoria||{}).map(([name,y])=>({name,y})) }]
    });
    charts.estado = Highcharts.chart('estadoChart', {
      chart:{ type:'pie' },
      series:[{ data: Object.entries(s.tickets_por_estado||{}).map(([name,y])=>({name,y})) }]
    });
    const trendEntries = Object.entries(s.tendencia_mensual||{}).sort(([a],[b])=>a.localeCompare(b));
    charts.trend = Highcharts.chart('trendChart', {
      chart:{ type:'line' },
      xAxis:{ categories: trendEntries.map(([k])=>k) },
      series:[{ name:'Tickets', data: trendEntries.map(([,v])=>v) }]
    });

    renderTechTable(dataStore.technician_stats);
  }

  function renderTechTable(list){
    const table = $('#techTable');
    const thead = table.querySelector('thead tr');
    const tbody = table.querySelector('tbody');
    const tfoot = table.querySelector('tfoot tr');

    const months = new Set();
    list.forEach(t=>{
      Object.keys(t).forEach(k=>{ if(k!=='Técnico' && Number.isInteger(t[k])) months.add(k); });
    });
    const monthsSorted = Array.from(months).sort((a,b)=>a.localeCompare(b));

    thead.innerHTML = `<th class="text-left text-white">Técnico</th>${monthsSorted.map(m=>`<th class="text-center text-white">${m}</th>`).join('')}<th class="text-right text-white">Total</th>`;
    tbody.innerHTML = '';
    const monthTotals = {}; let grand = 0;

    list.forEach(t=>{
      let total = 0;
      const cells = monthsSorted.map(m=>{
        const v = t[m] || 0; 
        total += v; 
        monthTotals[m] = (monthTotals[m]||0)+v;
        const cellClass = v === 0 ? 'cell-zero' : 'cell-colored';
        return `<td class="text-center ${cellClass}">${v}</td>`;
      }).join('');
      grand += total;
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${t['Técnico']}</td>${cells}<td class="text-right font-bold">${total}</td>`;
      tbody.appendChild(tr);
    });

    const footerCells = monthsSorted.map(m=>{
      const val = monthTotals[m]||0;
      const cellClass = val === 0 ? 'cell-zero' : 'cell-colored';
      return `<td class="text-center font-bold ${cellClass}">${val}</td>`;
    }).join('');
    tfoot.innerHTML = `<td>Total General</td>${footerCells}<td class="text-right font-bold">${grand}</td>`;
  }

  function exportChart(id){
    const c = Highcharts.charts.find(x=>x && x.renderTo.id===id);
    if(c) c.exportChart({ type:'image/jpeg', filename:`chart-${id}` });
  }

  function exportTableToJPG(){
    const container = document.createElement('div');
    container.style.background = 'white';
    container.style.padding = '1rem';
    container.style.borderRadius = '12px';

    const logoHeader = document.createElement('div');
    logoHeader.style.display = 'flex';
    logoHeader.style.alignItems = 'center';
    logoHeader.style.gap = '1rem';
    logoHeader.style.paddingBottom = '1rem';
    logoHeader.style.borderBottom = '2px solid #0d2d62';
    logoHeader.style.marginBottom = '1rem';

    const logoImg = document.createElement('img');
    logoImg.src = 'https://www.gob.pe/rails/active_storage/representations/redirect/eyJfcmFpbHMiOnsiZGF0YSI6MTQ1MDAsInB1ciI6ImJsb2JfaWQifX0=--d56e8d89845af7a460ccbe0d65ed319826301586/eyJfcmFpbHMiOnsiZGF0YSI6eyJmb3JtYXQiOiJwbmciLCJyZXNpemVfdG9fbGltaXQiOltudWxsLDQ4XX0sInB1ciI6InZhcmlhdGlvbiJ9fQ==--830247c4bafe7cadca50817d8559bf1a09e3aa28/Sin%20ti%CC%81tulo-1-01%20(1).png';
    logoImg.style.height = '40px';
    logoImg.style.width = 'auto';

    const title = document.createElement('h2');
    title.textContent = 'Reporte GLPI – SENASA';
    title.style.color = '#0d2d62';
    title.style.fontSize = '18px';
    title.style.fontWeight = 'bold';
    title.style.margin = '0';

    logoHeader.appendChild(logoImg);
    logoHeader.appendChild(title);
    container.appendChild(logoHeader);

    const table = document.getElementById('techTable').cloneNode(true);
    container.appendChild(table);

    document.body.appendChild(container);

    html2canvas(container, { scale: 2, backgroundColor:'#ffffff', logging: false }).then(canvas=>{
      const a = document.createElement('a');
      a.href = canvas.toDataURL('image/jpeg', 1.0);
      a.download = 'tickets_por_tecnico.jpg';
      a.click();
      document.body.removeChild(container);
    }).catch(err=>{
      console.error(err);
      document.body.removeChild(container);
    });
  }

  function exportTableToPDF(){
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('l','pt','a4');
    const table = document.getElementById('techTable');
    const head = [Array.from(table.querySelectorAll('thead th')).map(th=>th.textContent.trim())];
    const body = Array.from(table.querySelectorAll('tbody tr')).map(tr => Array.from(tr.children).map(td=>td.textContent.trim()));
    
    doc.text('Tickets por Técnico – SENASA', 40, 40);
    doc.autoTable({ 
      head, body, startY: 60, 
      styles:{ fontSize:8, cellPadding:3 }, 
      headStyles:{ fillColor:[13,45,98], textColor:255 }
    });
    doc.save('tickets_por_tecnico.pdf');
  }

  function exportTableToExcel(){
    const table = document.getElementById('techTable');
    const wb = XLSX.utils.table_to_book(table, { sheet:"Tickets por Técnico" });
    const wbout = XLSX.write(wb, { bookType:'xlsx', type:'array' });
    const blob = new Blob([wbout], {type:'application/octet-stream'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'tickets_por_tecnico.xlsx';
    a.click();
  }
</script>
</body>
</html>
