<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Reportes GLPI – SENASA</title>

<link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://code.highcharts.com/highcharts.js"></script>
<script src="https://code.highcharts.com/modules/variable-pie.js"></script>
<script src="https://code.highcharts.com/modules/exporting.js"></script>
<script src="https://code.highcharts.com/modules/export-data.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.19.3/xlsx.full.min.js"></script>

<style>
  :root { --azul:#0d2d62; --azul2:#113b7f; --stroke: rgba(255,255,255,.08); }
  body{ background: #0a0f1a; color:#e9eef5; font-family: Inter, system-ui, sans-serif; }
  header{ background: linear-gradient(90deg, var(--azul), var(--azul2)); }
  .panel{ background:#0f1625; border:1px solid var(--stroke); border-radius:16px; }
  .btn{ padding:.6rem .9rem; border-radius:10px; background:#113b7f; color:#fff; }
  .btn:hover{ filter: brightness(1.08); }
  .upload-zone{ border:2px dashed rgba(255,255,255,.2); padding:2rem; border-radius:14px; cursor:pointer; }
  .upload-zone:hover{ background:rgba(17,59,127,.15); }
  .chart-container{ width:100%; height:360px; }
  /* Tabla estilo SENASA */
  table{ width:100%; border-collapse: collapse; }
  thead th{ background: var(--azul); color:#fff; position: sticky; top:0; z-index:1; }
  th, td{ padding:.7rem .8rem; border-bottom: 1px solid #e5e7eb; color:#0a0f1a; }
  tbody tr:nth-child(odd){ background:#ffffff; }
  tbody tr:nth-child(even){ background:#f8fafc; }
  tfoot td{ background:#eaf2ff; color:#0a0f1a; font-weight:700; }
  .table-wrap{ background:#ffffff; border-radius:12px; overflow:auto; }
</style>
</head>
<body class="pb-12">
  <header class="p-5">
    <div class="max-w-7xl mx-auto flex items-center gap-4">
      <img src="https://s3.amazonaws.com/documentos.api.gob.pe/9smhbpmapffwdhy4kkc6mhwz8tvf?response-content-disposition=inline%3B%20filename%3D%22Sin%20ti%253Ftulo-1-01%20%25281%2529.png%22%3B%20filename%2A%3DUTF-8%27%27Sin%2520ti%25CC%2581tulo-1-01%2520%25281%2529.png&response-content-type=image%2Fpng&X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=AKIAJREKOSPKMJFYJDAQ%2F20251111%2Fus-east-1%2Fs3%2Faws4_request&X-Amz-Date=20251111T032430Z&X-Amz-Expires=300&X-Amz-SignedHeaders=host&X-Amz-Signature=c69efa5a234b1a50a7f5a7447321a7b4950da204cc2bed78530767256864094a"
           alt="SENASA" class="h-10 w-auto" onerror="this.style.display='none'"/>
      <div>
        <h1 class="text-2xl md:text-3xl font-extrabold tracking-wide">Reportes GLPI – SENASA</h1>
        <p class="opacity-80">Sistema de análisis de tickets</p>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto p-6 space-y-8">
    <!-- Subida -->
    <section class="panel p-6">
      <form id="uploadForm" class="max-w-xl mx-auto">
        <div class="upload-zone text-center" onclick="document.getElementById('file').click()">
          <i class="fas fa-cloud-upload-alt text-5xl mb-4 text-blue-300"></i>
          <input id="file" type="file" name="file" accept=".csv" class="hidden" />
          <p class="text-lg font-semibold text-white/90">Arrastra tu CSV o haz clic para seleccionar</p>
          <p class="text-sm text-white/70 mt-1">Encabezados soportados: ID/Id, Fecha, Estado, Prioridad, Técnico/Tecnico, Categoría/Categoria</p>
        </div>
      </form>
    </section>

    <!-- KPIs -->
    <section id="kpis" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-5 hidden">
      <div class="panel p-5">
        <div class="text-white/70 text-sm">Total Tickets</div>
        <div id="k_total" class="text-4xl font-extrabold">0</div>
      </div>
      <div class="panel p-5">
        <div class="text-white/70 text-sm">Total Técnicos</div>
        <div id="k_tecnicos" class="text-4xl font-extrabold">0</div>
      </div>
      <div class="panel p-5">
        <div class="text-white/70 text-sm">Pendientes</div>
        <div id="k_pend" class="text-4xl font-extrabold">0</div>
      </div>
      <div class="panel p-5">
        <div class="text-white/70 text-sm">Eficiencia</div>
        <div id="k_eff" class="text-4xl font-extrabold">0%</div>
      </div>
    </section>

    <!-- Gráficos -->
    <section id="charts" class="grid grid-cols-1 lg:grid-cols-2 gap-6 hidden">
      <div class="panel p-6">
        <div class="flex justify-between items-center mb-3">
          <h3 class="text-xl font-bold">Distribución por Categoría</h3>
          <button class="btn" onclick="exportChart('categChart')"><i class="fas fa-download mr-2"></i>JPG</button>
        </div>
        <div id="categChart" class="chart-container"></div>
      </div>
      <div class="panel p-6">
        <div class="flex justify-between items-center mb-3">
          <h3 class="text-xl font-bold">Estados</h3>
          <button class="btn" onclick="exportChart('estadoChart')"><i class="fas fa-download mr-2"></i>JPG</button>
        </div>
        <div id="estadoChart" class="chart-container"></div>
      </div>
      <div class="panel p-6 lg:col-span-2">
        <div class="flex justify-between items-center mb-3">
          <h3 class="text-xl font-bold">Tendencia Mensual</h3>
          <button class="btn" onclick="exportChart('trendChart')"><i class="fas fa-download mr-2"></i>JPG</button>
        </div>
        <div id="trendChart" class="chart-container"></div>
      </div>
    </section>

    <!-- Tabla -->
    <section id="tableSection" class="space-y-3 hidden">
      <div class="flex justify-between items-center">
        <h3 class="text-xl font-bold">Tickets por Técnico</h3>
        <div class="flex gap-2">
          <button class="btn" onclick="exportTableToExcel()"><i class="fas fa-file-excel mr-2"></i>Excel</button>
          <button class="btn" onclick="exportTableToPDF()"><i class="fas fa-file-pdf mr-2"></i>PDF</button>
          <button class="btn" onclick="exportTableToJPG()"><i class="fas fa-image mr-2"></i>JPG</button>
        </div>
      </div>
      <div class="table-wrap">
        <table id="techTable">
          <thead>
            <tr><th class="text-left text-white">Técnico</th><th class="text-right text-white">Total</th></tr>
          </thead>
          <tbody></tbody>
          <tfoot><tr><td>Total General</td><td class="text-right">0</td></tr></tfoot>
        </table>
      </div>
    </section>
  </main>

  <!-- Overlay -->
  <div id="overlay" class="fixed inset-0 bg-black/70 hidden items-center justify-center z-50">
    <div class="text-center text-white">
      <i class="fas fa-cog fa-spin text-6xl text-blue-300 mb-4"></i>
      <p class="text-xl">Procesando datos…</p>
    </div>
  </div>

<script>
  let dataStore = null, charts = {};
  const $ = (s)=>document.querySelector(s);
  const show = (id)=>$(id).classList.remove('hidden');
  const hide = (id)=>$(id).classList.add('hidden');

  Highcharts.setOptions({
    chart:{ backgroundColor:'transparent', style:{ fontFamily:'Inter, system-ui, sans-serif' } },
    title:{ text:null }, credits:{ enabled:false },
    legend:{ itemStyle:{ color:'#e9eef5' } },
    xAxis:{ labels:{ style:{ color:'#cfd8e3'} } },
    yAxis:{ title:{ text:null }, labels:{ style:{ color:'#cfd8e3'} } },
    colors:['#1aa7ff','#00c2ff','#18e0c4','#7be495','#a3e7f0','#e7f0ff']
  });

  // Upload -> backend
  document.getElementById('file').addEventListener('change', async (e)=>{
    if(!e.target.files.length) return;
    const form = new FormData(); form.append('file', e.target.files[0]);
    show('#overlay');
    try{
      const res = await fetch('/api/upload', { method:'POST', body:form });
      const json = await res.json();
      if(!json.success) throw new Error(json.error || 'Error procesando CSV');
      dataStore = json.data;
      renderAll();
    }catch(err){
      alert('Error: '+err.message);
    }finally{ hide('#overlay'); }
  });

  function renderAll(){
    show('#kpis'); show('#charts'); show('#tableSection');
    const s = dataStore.dashboard_stats;
    const total = Object.values(s.tickets_por_categoria||{}).reduce((a,b)=>a+b,0);
    const pendientes = s.tickets_por_estado?.Pendiente || s.tickets_por_estado?.pendiente || 0;
    const resueltos  = s.tickets_por_estado?.Resuelto || s.tickets_por_estado?.resuelto || 0;
    const totalEst = Object.values(s.tickets_por_estado||{}).reduce((a,b)=>a+b,0);
    const eff = totalEst ? (resueltos/totalEst)*100 : 0;

    $('#k_total').textContent = total.toLocaleString();
    $('#k_tecnicos').textContent = dataStore.technician_stats.length.toLocaleString();
    $('#k_pend').textContent = pendientes.toLocaleString();
    $('#k_eff').textContent = eff.toFixed(1)+'%';

    // charts
    charts.categ = Highcharts.chart('categChart', {
      chart:{ type:'variablepie' },
      series:[{ innerSize:'55%', data: Object.entries(s.tickets_por_categoria||{}).map(([name,y])=>({name,y})) }]
    });
    charts.estado = Highcharts.chart('estadoChart', {
      chart:{ type:'pie' },
      series:[{ data: Object.entries(s.tickets_por_estado||{}).map(([name,y])=>({name,y})) }]
    });
    const trendEntries = Object.entries(s.tendencia_mensual||{}).sort(([a],[b])=>a.localeCompare(b));
    charts.trend = Highcharts.chart('trendChart', {
      chart:{ type:'line' },
      xAxis:{ categories: trendEntries.map(([k])=>k) },
      series:[{ name:'Tickets', data: trendEntries.map(([,v])=>v) }]
    });

    // table
    renderTechTable(dataStore.technician_stats);
  }

  function renderTechTable(list){
    const table = $('#techTable');
    const thead = table.querySelector('thead tr');
    const tbody = table.querySelector('tbody');
    const tfoot = table.querySelector('tfoot tr');

    // meses presentes
    const months = new Set();
    list.forEach(t=>{
      Object.keys(t).forEach(k=>{ if(k!=='Técnico' && Number.isInteger(t[k])) months.add(k); });
    });
    const monthsSorted = Array.from(months).sort((a,b)=>a.localeCompare(b));

    thead.innerHTML = `<th class="text-left text-white">Técnico</th>${monthsSorted.map(m=>`<th class="text-center text-white">${m}</th>`).join('')}<th class="text-right text-white">Total</th>`;
    tbody.innerHTML = '';
    const monthTotals = {}; let grand = 0;

    list.forEach(t=>{
      let total = 0;
      const cells = monthsSorted.map(m=>{
        const v = t[m] || 0; total += v; monthTotals[m] = (monthTotals[m]||0)+v;
        return `<td class="text-center">${v}</td>`;
      }).join('');
      grand += total;
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${t['Técnico']}</td>${cells}<td class="text-right font-bold">${total}</td>`;
      tbody.appendChild(tr);
    });

    tfoot.innerHTML = `<td>Total General</td>${monthsSorted.map(m=>`<td class="text-center font-bold">${monthTotals[m]||0}</td>`).join('')}<td class="text-right font-bold">${grand}</td>`;
  }

  // Export charts
  function exportChart(id){
    const c = Highcharts.charts.find(x=>x && x.renderTo.id===id);
    if(c) c.exportChart({ type:'image/jpeg', filename:`chart-${id}` });
  }

  // Export table
  function exportTableToJPG(){
    const node = document.querySelector('.table-wrap');
    html2canvas(node, { scale: 2, backgroundColor:'#ffffff' }).then(canvas=>{
      const a = document.createElement('a');
      a.href = canvas.toDataURL('image/jpeg', 1.0);
      a.download = 'tickets_por_tecnico.jpg'; a.click();
    });
  }
  function exportTableToPDF(){
    const { jsPDF } = window.jspdf; const doc = new jsPDF('l','pt','a4');
    const table = document.getElementById('techTable');
    const head = [Array.from(table.querySelectorAll('thead th')).map(th=>th.textContent.trim())];
    const body = Array.from(table.querySelectorAll('tbody tr')).map(tr => Array.from(tr.children).map(td=>td.textContent.trim()));
    doc.text('Tickets por Técnico – SENASA', 40, 40);
    doc.autoTable({ head, body, startY: 60, styles:{ fontSize:8, cellPadding:3 }, headStyles:{ fillColor:[13,45,98], textColor:255 }});
    doc.save('tickets_por_tecnico.pdf');
  }
  function exportTableToExcel(){
    const table = document.getElementById('techTable');
    const wb = XLSX.utils.table_to_book(table, { sheet:"Tickets por Técnico" });
    const wbout = XLSX.write(wb, { bookType:'xlsx', type:'array' });
    const blob = new Blob([wbout], {type:'application/octet-stream'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'tickets_por_tecnico.xlsx'; a.click();
  }
</script>
</body>
</html>
