<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Reportes GLPI – SENASA</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://code.highcharts.com/highcharts.js"></script>
<script src="https://code.highcharts.com/modules/variable-pie.js"></script>
<script src="https://code.highcharts.com/modules/exporting.js"></script>
<script src="https://code.highcharts.com/modules/export-data.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.19.3/xlsx.full.min.js"></script>

<style>
  :root { 
    --azul:#0d2d62; 
    --azul2:#113b7f; 
    --turquesa:#00d4ff;
    --accent:#ff6b35;
    --stroke: rgba(255,255,255,.08); 
  }
  
  * { box-sizing: border-box; }
  
  body{ 
    background: linear-gradient(135deg, #0a0f1a 0%, #0f1b2e 100%); 
    color:#e9eef5; 
    font-family: Inter, system-ui, sans-serif;
    min-height: 100vh;
  }
  
  /* Header Styles */
  header{ 
    background: linear-gradient(135deg, var(--azul) 0%, var(--azul2) 50%, #1a4d7f 100%);
    box-shadow: 0 8px 32px rgba(0,0,0,0.3);
    backdrop-filter: blur(10px);
    border-bottom: 2px solid rgba(0,212,255,.3);
  }
  
  .senasa-logo {
    background: rgba(255,255,255,0.95);
    padding: 0.3rem 0.5rem;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  /* Panel Styles */
  .panel{ 
    background: rgba(15,22,37,0.8);
    border:1px solid var(--stroke); 
    border-radius:16px;
    backdrop-filter: blur(10px);
    transition: all 0.3s ease;
  }
  
  .panel:hover {
    border-color: rgba(0,212,255,.3);
    box-shadow: 0 8px 24px rgba(0,212,255,.1);
  }
  
  /* Button Styles */
  .btn{ 
    padding:.6rem .9rem; 
    border-radius:10px; 
    background: linear-gradient(135deg, #00d4ff, #0099cc);
    color:#000; 
    font-weight: 600;
    border: none;
    cursor: pointer;
    transition: all 0.3s ease;
  }
  
  .btn:hover{ 
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(0,212,255,.4);
    filter: brightness(1.1);
  }
  
  /* Upload Zone */
  .upload-zone{ 
    border:2px dashed var(--turquesa); 
    padding:2rem; 
    border-radius:14px; 
    cursor:pointer;
    background: rgba(0,212,255,.05);
    transition: all 0.3s ease;
  }
  
  .upload-zone:hover{ 
    background:rgba(0,212,255,.15);
    border-color: var(--accent);
    transform: scale(1.01);
  }
  
  .chart-container{ width:100%; height:360px; }
  
  /* KPI Cards */
  .kpi-card {
    background: linear-gradient(135deg, rgba(0,212,255,.1), rgba(0,212,255,.05));
    border: 1px solid rgba(0,212,255,.2);
    border-radius: 14px;
    padding: 1.5rem;
    transition: all 0.3s ease;
  }
  
  .kpi-card:hover {
    transform: translateY(-4px);
    border-color: rgba(0,212,255,.3);
    box-shadow: 0 8px 24px rgba(0,212,255,.15);
  }
  
  .kpi-label {
    text-transform: uppercase;
    font-size: 0.75rem;
    font-weight: 700;
    opacity: 0.8;
    letter-spacing: 0.05em;
  }
  
  .kpi-value {
    font-size: 2.5rem;
    font-weight: 800;
    background: linear-gradient(135deg, var(--turquesa), #00a8cc);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-top: 0.5rem;
  }
  
  /* General Tables */
  table{ width:100%; border-collapse: separate; border-spacing: 0; }
  
  /* Estilos específicos para bordes de tabla */
  th, td { border-bottom: 1px solid #e5e7eb; border-right: 1px solid #eee; }
  th:last-child, td:last-child { border-right: none; }
  
  thead th{ 
    position: sticky; 
    top:0; 
    z-index:10;
  }
  
  tbody tr:nth-child(odd){ background:#ffffff; }
  tbody tr:nth-child(even){ background:#f8fafc; }
  tbody tr:hover { background: #e6f2ff; transition: background 0.2s; }
  
  .table-wrap{ 
    background:#ffffff; 
    border-radius:12px; 
    overflow:auto; 
    box-shadow: 0 4px 20px rgba(0,0,0,.1); 
  }
  
  .cell-colored {
    background: #d4e6ff !important;
    color: #0a0f1a;
    font-weight: 700;
  }
  
  .cell-zero {
    color: #ccc;
    font-size: 0.85rem;
  }

  .spinner {
    background: linear-gradient(135deg, var(--turquesa), var(--accent));
  }
  
  /* Scrollbar personalizado para las tablas */
  .table-wrap::-webkit-scrollbar { height: 8px; width: 8px; }
  .table-wrap::-webkit-scrollbar-track { background: #f1f1f1; }
  .table-wrap::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
  .table-wrap::-webkit-scrollbar-thumb:hover { background: #555; }
</style>
</head>
<body class="pb-12">

  <header class="p-5">
    <div class="max-w-7xl mx-auto flex items-center gap-4">
      <div class="senasa-logo">
        <img src="https://www.gob.pe/rails/active_storage/representations/redirect/eyJfcmFpbHMiOnsiZGF0YSI6MTQ1MDAsInB1ciI6ImJsb2JfaWQifX0=--d56e8d89845af7a460ccbe0d65ed319826301586/eyJfcmFpbHMiOnsiZGF0YSI6eyJmb3JtYXQiOiJwbmciLCJyZXNpemVfdG9fbGltaXQiOltudWxsLDQ4XX0sInB1ciI6InZhcmlhdGlvbiJ9fQ==--830247c4bafe7cadca50817d8559bf1a09e3aa28/Sin%20ti%CC%81tulo-1-01%20(1).png"
             alt="SENASA" class="h-8 w-auto"/>
      </div>
      <div class="flex-1">
        <h1 class="text-3xl font-extrabold tracking-wide bg-gradient-to-r from-cyan-300 to-blue-300 bg-clip-text text-transparent">Reportes GLPI – SENASA</h1>
        <p class="opacity-80 text-sm">Sistema inteligente de análisis de tickets</p>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto p-6 space-y-8">
    
    <section class="panel p-6">
      <form id="uploadForm" class="max-w-2xl mx-auto">
        <div class="upload-zone text-center" onclick="document.getElementById('file').click()">
          <i class="fas fa-cloud-upload-alt text-6xl mb-4 text-cyan-300"></i>
          <input id="file" type="file" name="file" accept=".csv" class="hidden" />
          <p class="text-lg font-semibold text-white/90">Arrastra tu CSV o haz clic para seleccionar</p>
          <p class="text-sm text-white/70 mt-2">Encabezados requeridos en CSV</p>
        </div>
      </form>
    </section>

    <section id="kpis" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-5 hidden">
      <div class="kpi-card">
        <div class="kpi-label">Total Tickets</div>
        <div id="k_total" class="kpi-value">0</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">Total Técnicos</div>
        <div id="k_tecnicos" class="kpi-value">0</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">Pendientes</div>
        <div id="k_pend" class="kpi-value">0</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">Eficiencia</div>
        <div id="k_eff" class="kpi-value">0%</div>
      </div>
    </section>

    <section id="charts" class="grid grid-cols-1 lg:grid-cols-2 gap-6 hidden">
      <div class="panel p-6">
        <div class="flex justify-between items-center mb-3">
          <h3 class="text-xl font-bold">Distribución por Categoría</h3>
          <button class="btn" onclick="exportChart('categChart')"><i class="fas fa-download mr-2"></i>JPG</button>
        </div>
        <div id="categChart" class="chart-container"></div>
      </div>
      <div class="panel p-6">
        <div class="flex justify-between items-center mb-3">
          <h3 class="text-xl font-bold">Estados</h3>
          <button class="btn" onclick="exportChart('estadoChart')"><i class="fas fa-download mr-2"></i>JPG</button>
        </div>
        <div id="estadoChart" class="chart-container"></div>
      </div>
      <div class="panel p-6 lg:col-span-2">
        <div class="flex justify-between items-center mb-3">
          <h3 class="text-xl font-bold">Tendencia Mensual</h3>
          <button class="btn" onclick="exportChart('trendChart')"><i class="fas fa-download mr-2"></i>JPG</button>
        </div>
        <div id="trendChart" class="chart-container"></div>
      </div>
    </section>

    <section id="tableSection" class="space-y-3 hidden">
      <div class="flex justify-between items-center">
        <h3 class="text-xl font-bold">Tickets por Técnico (Mensual)</h3>
        <div class="flex gap-2">
          <button class="btn" onclick="exportTableToExcel()"><i class="fas fa-file-excel mr-2"></i>Excel</button>
          <button class="btn" onclick="exportTableToPDF()"><i class="fas fa-file-pdf mr-2"></i>PDF</button>
          <button class="btn" onclick="exportTableToJPG()"><i class="fas fa-image mr-2"></i>JPG</button>
        </div>
      </div>
      <div class="table-wrap">
        <table id="techTable">
          <thead>
            <tr><th class="text-left text-white bg-[#0d2d62]">Técnico</th><th class="text-right text-white bg-[#0d2d62]">Total</th></tr>
          </thead>
          <tbody></tbody>
          <tfoot><tr><td>Total General</td><td class="text-right">0</td></tr></tfoot>
        </table>
      </div>
    </section>

    <section id="dailyReportSection" class="space-y-3 hidden">
      <div class="flex justify-between items-center">
        <h3 class="text-xl font-bold">Reporte Diario por Técnico</h3>
        <div class="flex gap-2">
          <button class="btn" onclick="openDailyReportModal()"><i class="fas fa-calendar-day mr-2"></i>Ver Reporte Diario</button>
        </div>
      </div>
    </section>
  </main>

  <div id="overlay" class="fixed inset-0 bg-black/70 hidden items-center justify-center z-50">
    <div class="text-center text-white">
      <div class="relative w-20 h-20 mx-auto mb-4">
        <div class="spinner absolute inset-0 rounded-full opacity-75" style="animation: spin 3s linear infinite;"></div>
      </div>
      <p class="text-xl font-semibold">Procesando datos…</p>
    </div>
  </div>

  <div id="dailyReportModal" class="fixed inset-0 bg-black/80 hidden items-center justify-center z-50 p-4 backdrop-blur-sm">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-[95vw] h-[90vh] flex flex-col overflow-hidden">
      <div class="bg-[#0d2d62] p-4 flex justify-between items-center shrink-0">
        <div class="flex items-center gap-3">
            <i class="fas fa-calendar-alt text-cyan-300 text-2xl"></i>
            <h2 class="text-2xl font-bold text-white">Reporte Diario Detallado</h2>
        </div>
        <button onclick="closeDailyReportModal()" class="text-white hover:text-cyan-300 text-3xl transition-colors">&times;</button>
      </div>
      
      <div class="bg-gray-100 p-3 border-b border-gray-200 flex justify-end gap-2 shrink-0">
        <button class="btn text-sm py-2" onclick="exportDailyToExcel()"><i class="fas fa-file-excel mr-2"></i>Excel</button>
        <button class="btn text-sm py-2" onclick="exportDailyToPDF()"><i class="fas fa-file-pdf mr-2"></i>PDF</button>
        <button class="btn text-sm py-2" onclick="exportDailyToJPG()"><i class="fas fa-image mr-2"></i>JPG</button>
      </div>

      <div class="flex-1 overflow-auto bg-gray-50 p-4">
        <div class="bg-white shadow-lg rounded-lg overflow-hidden">
          <table id="dailyTable" class="w-full text-sm">
            <thead>
              </thead>
            <tbody class="text-gray-700">
               </tbody>
            <tfoot class="bg-gray-100 font-bold border-t-2 border-gray-300">
               </tfoot>
          </table>
        </div>
      </div>
    </div>
  </div>

<script>
  let dataStore = null, charts = {};
  const $ = (s)=>document.querySelector(s);
  const show = (id)=>$(id).classList.remove('hidden');
  const hide = (id)=>$(id).classList.add('hidden');

  // Configuración Highcharts
  Highcharts.setOptions({
    chart:{ backgroundColor:'transparent', style:{ fontFamily:'Inter, system-ui, sans-serif' } },
    title:{ text:null }, credits:{ enabled:false },
    legend:{ itemStyle:{ color:'#e9eef5' } },
    xAxis:{ labels:{ style:{ color:'#cfd8e3'} } },
    yAxis:{ title:{ text:null }, labels:{ style:{ color:'#cfd8e3'} } },
    colors:['#00d4ff','#00f5ff','#00e6e6','#00d4a8','#00c2ff','#a8d4ff']
  });

  // Manejador de subida de archivo
  document.getElementById('file').addEventListener('change', async (e)=>{
    if(!e.target.files.length) return;
    const form = new FormData(); form.append('file', e.target.files[0]);
    show('#overlay');
    try{
      const res = await fetch('/api/upload', { method:'POST', body:form });
      const json = await res.json();
      if(!json.success) throw new Error(json.error || 'Error procesando CSV');
      dataStore = json.data;
      renderAll();
    }catch(err){
      alert('Error: '+err.message);
    }finally{ hide('#overlay'); }
  });

  function renderAll(){
    show('#kpis'); show('#charts'); show('#tableSection'); show('#dailyReportSection');
    const s = dataStore.dashboard_stats;
    const total = Object.values(s.tickets_por_categoria||{}).reduce((a,b)=>a+b,0);
    const pendientes = s.tickets_por_estado?.Pendiente || s.tickets_por_estado?.pendiente || 0;
    const resueltos  = s.tickets_por_estado?.Resuelto || s.tickets_por_estado?.resuelto || 0;
    const totalEst = Object.values(s.tickets_por_estado||{}).reduce((a,b)=>a+b,0);
    const eff = totalEst ? (resueltos/totalEst)*100 : 0;

    $('#k_total').textContent = total.toLocaleString();
    $('#k_tecnicos').textContent = dataStore.technician_stats.length.toLocaleString();
    $('#k_pend').textContent = pendientes.toLocaleString();
    $('#k_eff').textContent = eff.toFixed(1)+'%';

    // Gráficos
    if(charts.categ) charts.categ.destroy();
    if(charts.estado) charts.estado.destroy();
    if(charts.trend) charts.trend.destroy();

    charts.categ = Highcharts.chart('categChart', {
      chart:{ type:'variablepie' },
      series:[{ innerSize:'55%', data: Object.entries(s.tickets_por_categoria||{}).map(([name,y])=>({name,y})) }]
    });
    charts.estado = Highcharts.chart('estadoChart', {
      chart:{ type:'pie' },
      series:[{ data: Object.entries(s.tickets_por_estado||{}).map(([name,y])=>({name,y})) }]
    });
    const trendEntries = Object.entries(s.tendencia_mensual||{}).sort(([a],[b])=>a.localeCompare(b));
    charts.trend = Highcharts.chart('trendChart', {
      chart:{ type:'line' },
      xAxis:{ categories: trendEntries.map(([k])=>k) },
      series:[{ name:'Tickets', data: trendEntries.map(([,v])=>v) }]
    });

    renderTechTable(dataStore.technician_stats);
  }

  // Tabla Mensual Simple
  function renderTechTable(list){
    const table = $('#techTable');
    const thead = table.querySelector('thead tr');
    const tbody = table.querySelector('tbody');
    const tfoot = table.querySelector('tfoot tr');

    const months = new Set();
    list.forEach(t=>{
      Object.keys(t).forEach(k=>{ if(k!=='Técnico' && Number.isInteger(t[k])) months.add(k); });
    });
    const monthsSorted = Array.from(months).sort((a,b)=>a.localeCompare(b));

    thead.innerHTML = `<th class="text-left text-white bg-[#0d2d62] p-2">Técnico</th>${monthsSorted.map(m=>`<th class="text-center text-white bg-[#0d2d62] p-2">${m}</th>`).join('')}<th class="text-right text-white bg-[#0d2d62] p-2">Total</th>`;
    tbody.innerHTML = '';
    const monthTotals = {}; let grand = 0;

    list.forEach(t=>{
      let total = 0;
      const cells = monthsSorted.map(m=>{
        const v = t[m] || 0; 
        total += v; 
        monthTotals[m] = (monthTotals[m]||0)+v;
        const cellClass = v >= 6 ? 'cell-colored' : 'cell-zero';
        return `<td class="text-center ${cellClass}">${v}</td>`;
      }).join('');
      grand += total;
      const tr = document.createElement('tr');
      tr.innerHTML = `<td class="p-2 font-semibold">${t['Técnico']}</td>${cells}<td class="text-right font-bold p-2">${total}</td>`;
      tbody.appendChild(tr);
    });

    const footerCells = monthsSorted.map(m=>{
      const val = monthTotals[m]||0;
      return `<td class="text-center font-bold p-2">${val}</td>`;
    }).join('');
    tfoot.innerHTML = `<td class="p-2">Total General</td>${footerCells}<td class="text-right font-bold p-2">${grand}</td>`;
  }

  // ==========================================
  // LÓGICA REPORTE DIARIO (3 NIVELES HEADER) - CORREGIDA
  // ==========================================
  async function openDailyReportModal(){
    show('#overlay');
    try{
      const res = await fetch('/api/daily-report');
      const json = await res.json();
      if(!json.success) throw new Error(json.error || 'Error cargando reporte diario');
      
      renderDailyTable(json.data.daily_stats);
      
      $('#dailyReportModal').classList.remove('hidden');
      $('#dailyReportModal').classList.add('flex');
    }catch(err){
      alert('Error: '+err.message);
    }finally{ hide('#overlay'); }
  }

  function closeDailyReportModal(){
    $('#dailyReportModal').classList.add('hidden');
    $('#dailyReportModal').classList.remove('flex');
  }

  function renderDailyTable(list){
    const table = $('#dailyTable');
    const thead = table.querySelector('thead');
    const tbody = table.querySelector('tbody');
    const tfoot = table.querySelector('tfoot');

    // 1. Estructura Jerárquica: Año -> Mes -> Días
    const hierarchy = {}; // { "2025": { "noviembre": Set(17, 18...), "diciembre": Set(1...) } }

    list.forEach(t => {
        Object.keys(t).forEach(k => {
            if(k !== 'Técnico' && k.includes('|')) {
                // Formato esperado: "2025-noviembre|17"
                const [anioMes, dia] = k.split('|');
                const [anio, mes] = anioMes.split('-'); // Separa 2025 de noviembre

                if(!hierarchy[anio]) hierarchy[anio] = {};
                if(!hierarchy[anio][mes]) hierarchy[anio][mes] = new Set();
                hierarchy[anio][mes].add(dia);
            }
        });
    });

    // Helper para ordenar meses
    const mesesOrder = {
        'enero': 1, 'febrero': 2, 'marzo': 3, 'abril': 4, 'mayo': 5, 'junio': 6,
        'julio': 7, 'agosto': 8, 'septiembre': 9, 'octubre': 10, 'noviembre': 11, 'diciembre': 12
    };

    const aniosOrdenados = Object.keys(hierarchy).sort();

    // 2. Construir Encabezados (3 Filas)
    const trYear = document.createElement('tr');
    const trMonth = document.createElement('tr');
    const trDay = document.createElement('tr');

    // -- Columna TÉCNICO --
    const thTecnico = document.createElement('th');
    thTecnico.textContent = 'Técnico';
    thTecnico.className = 'text-left text-white bg-[#0d2d62] p-3 align-middle sticky left-0 z-20';
    thTecnico.rowSpan = 3;
    trYear.appendChild(thTecnico);

    // -- Iterar Años y Meses --
    const flatColumns = []; // { key: '2025-noviembre|17', type: 'day' }

    aniosOrdenados.forEach(anio => {
        const meses = hierarchy[anio];
        // Ordenamos los meses por calendario, no alfabéticamente
        const mesesDelAnio = Object.keys(meses).sort((a,b) => (mesesOrder[a.toLowerCase()]||99) - (mesesOrder[b.toLowerCase()]||99));
        
        let colspanAnio = 0;

        mesesDelAnio.forEach(mes => {
            // CORRECCION APLICADA: Usamos 'meses[mes]' directamente porque 'meses' ya es el objeto del año actual
            const dias = Array.from(meses[mes]).sort((a,b) => parseInt(a) - parseInt(b));
            
            // Header MES
            const thMes = document.createElement('th');
            thMes.textContent = mes.toUpperCase();
            thMes.className = 'text-center text-white font-bold uppercase bg-[#113b7f] border-l border-white/20';
            thMes.colSpan = dias.length + 1; // Dias + Subtotal
            trMonth.appendChild(thMes);

            colspanAnio += (dias.length + 1);

            // Headers DÍAS
            dias.forEach(dia => {
                const thDia = document.createElement('th');
                thDia.textContent = dia;
                thDia.className = 'text-center text-white text-xs bg-[#1a4d7f] min-w-[35px]';
                trDay.appendChild(thDia);
                flatColumns.push({ key: `${anio}-${mes}|${dia}`, type: 'day' });
            });

            // Header SUB
            const thSub = document.createElement('th');
            thSub.textContent = 'Sub';
            thSub.className = 'text-center text-white font-bold text-xs bg-[#0b2044]';
            trDay.appendChild(thSub);
            flatColumns.push({ key: `${anio}-${mes}`, type: 'subtotal' });
        });

        // Header AÑO
        const thAnio = document.createElement('th');
        thAnio.textContent = anio;
        thAnio.className = 'text-center text-white font-extrabold text-lg bg-[#0d2d62] border-l-2 border-cyan-400';
        thAnio.colSpan = colspanAnio;
        trYear.appendChild(thAnio);
    });

    // -- Columna TOTAL --
    const thTotal = document.createElement('th');
    thTotal.textContent = 'Total';
    thTotal.className = 'text-right text-white bg-[#0d2d62] p-3 align-middle border-l-2 border-orange-500';
    thTotal.rowSpan = 3;
    trYear.appendChild(thTotal);

    thead.innerHTML = '';
    thead.appendChild(trYear);
    thead.appendChild(trMonth);
    thead.appendChild(trDay);

    // 3. Construir Cuerpo
    tbody.innerHTML = '';
    let grandTotalSum = 0;
    const footerSums = new Array(flatColumns.length).fill(0);

    list.forEach(t => {
        const tr = document.createElement('tr');
        
        // Celda Técnico
        const tdTech = document.createElement('td');
        tdTech.textContent = t['Técnico'];
        tdTech.className = 'font-semibold sticky left-0 bg-white border-r border-gray-200 p-2 z-10';
        tr.appendChild(tdTech);

        let rowTotal = 0;
        let currentMesTotal = 0;

        flatColumns.forEach((col, index) => {
            const td = document.createElement('td');
            
            if(col.type === 'day') {
                const val = t[col.key] || 0;
                td.textContent = val;
                td.className = `text-center p-1 ${val > 0 ? 'bg-blue-50 text-blue-800 font-bold' : 'text-gray-300'}`;
                
                rowTotal += val;
                currentMesTotal += val;
                footerSums[index] += val;
            } else if(col.type === 'subtotal') {
                td.textContent = currentMesTotal;
                td.className = 'text-center font-bold bg-blue-100 text-blue-900 border-l border-blue-200';
                footerSums[index] += currentMesTotal;
                currentMesTotal = 0;
            }
            tr.appendChild(td);
        });

        grandTotalSum += rowTotal;

        const tdTotal = document.createElement('td');
        tdTotal.textContent = rowTotal;
        tdTotal.className = 'text-right font-black text-gray-800 border-l-2 border-orange-500 p-2 bg-orange-50';
        tr.appendChild(tdTotal);

        tbody.appendChild(tr);
    });

    // 4. Construir Footer
    tfoot.innerHTML = '';
    const trFoot = document.createElement('tr');
    
    const tdFootLabel = document.createElement('td');
    tdFootLabel.textContent = 'Totales';
    tdFootLabel.className = 'font-bold text-right p-2 sticky left-0 bg-gray-100 z-10 border-r';
    trFoot.appendChild(tdFootLabel);

    flatColumns.forEach((col, index) => {
        const td = document.createElement('td');
        td.textContent = footerSums[index];
        td.className = col.type === 'subtotal' 
            ? 'text-center font-bold bg-blue-200 text-blue-900 border-l border-blue-300' 
            : `text-center font-bold ${footerSums[index] > 0 ? 'bg-blue-50' : ''}`;
        trFoot.appendChild(td);
    });

    const tdGrand = document.createElement('td');
    tdGrand.textContent = grandTotalSum;
    tdGrand.className = 'text-right font-black text-lg bg-orange-100 border-l-2 border-orange-500 p-2';
    trFoot.appendChild(tdGrand);

    tfoot.appendChild(trFoot);
  }

  // ==========================================
  // EXPORTACIONES DEL REPORTE DIARIO
  // ==========================================
  function exportDailyToExcel(){
    const table = document.getElementById('dailyTable');
    // table_to_book maneja rowspans y colspans automáticamente
    const wb = XLSX.utils.table_to_book(table, { sheet:"Reporte Diario" });
    const wbout = XLSX.write(wb, { bookType:'xlsx', type:'array' });
    const blob = new Blob([wbout], {type:'application/octet-stream'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'reporte_diario_senasa.xlsx';
    a.click();
  }

  function exportDailyToPDF(){
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('l','pt','a3'); // A3 Horizontal
    
    doc.text('Reporte Diario Detallado – SENASA', 40, 40);
    
    // AutoTable soporta inputs directos de HTML y respeta colspans/rowspans
    doc.autoTable({
      html: '#dailyTable',
      startY: 60,
      styles:{ fontSize:7, cellPadding:2, lineColor: [200, 200, 200], lineWidth: 0.1 },
      headStyles:{ fillColor:[13,45,98], textColor:255, valign: 'middle', halign: 'center' },
      theme: 'grid',
      didParseCell: function(data) {
        // Estilo negrita para totales
        if (data.column.index === data.table.columns.length - 1) {
            data.cell.styles.fontStyle = 'bold';
            data.cell.styles.fillColor = [255, 237, 213]; // Naranja claro
        }
      }
    });
    doc.save('reporte_diario_senasa.pdf');
  }

  function exportDailyToJPG(){
    const originalTable = document.getElementById('dailyTable');
    
    // Clonar para la captura (para asegurar estilos y ancho completo)
    const container = document.createElement('div');
    container.style.background = 'white';
    container.style.padding = '20px';
    container.style.width = 'fit-content';
    container.style.position = 'absolute';
    container.style.top = '-9999px';
    
    // Cabecera imagen
    const header = document.createElement('div');
    header.innerHTML = `<h2 style="color:#0d2d62;font-family:sans-serif;font-size:24px;border-bottom:3px solid #0d2d62;padding-bottom:10px;margin-bottom:20px;">Reporte Diario GLPI - SENASA</h2>`;
    container.appendChild(header);

    const tableClone = originalTable.cloneNode(true);
    tableClone.style.width = 'auto'; // Dejar que se expanda
    // Quitar clases sticky para la foto
    tableClone.querySelectorAll('.sticky').forEach(el => {
        el.classList.remove('sticky');
        el.style.position = 'static';
    });
    container.appendChild(tableClone);
    document.body.appendChild(container);

    html2canvas(container, { 
        scale: 2, 
        backgroundColor:'#ffffff',
        logging: false
    }).then(canvas => {
        const a = document.createElement('a');
        a.href = canvas.toDataURL('image/jpeg', 0.9);
        a.download = 'reporte_diario_senasa.jpg';
        a.click();
        document.body.removeChild(container);
    }).catch(err => {
        console.error(err);
        document.body.removeChild(container);
        alert('Error generando imagen');
    });
  }

  function exportChart(id){
    const c = Highcharts.charts.find(x=>x && x.renderTo.id===id);
    if(c) c.exportChart({ type:'image/jpeg', filename:`chart-${id}` });
  }

  function exportTableToJPG(){
      // Lógica para exportar tabla mensual a JPG (simplificada)
      const container = document.createElement('div');
      container.style.background = '#fff';
      container.style.padding = '20px';
      container.appendChild($('#techTable').cloneNode(true));
      document.body.appendChild(container);
      html2canvas(container).then(c => {
          const a = document.createElement('a');
          a.href = c.toDataURL('image/jpeg');
          a.download = 'tabla_mensual.jpg';
          a.click();
          document.body.removeChild(container);
      });
  }
  function exportTableToPDF(){ /* Ya implementado arriba para la mensual */ 
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF('l','pt','a4');
      doc.autoTable({ html: '#techTable', startY:40 });
      doc.save('mensual.pdf');
  }
  function exportTableToExcel(){ 
      const wb = XLSX.utils.table_to_book($('#techTable'), {sheet:"Mensual"});
      XLSX.writeFile(wb, 'mensual.xlsx');
  }
</script>
</body>
</html>
